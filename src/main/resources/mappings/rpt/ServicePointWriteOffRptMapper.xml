<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kkl.kklplus.provider.rpt.mapper.ServicePointWriteOffRptMapper">

    <select id="getServicePointWriteOffListFromWebDB"
            resultType="com.kkl.kklplus.entity.rpt.RPTServicePointWriteOffEntity">
        SELECT
              fec.id  AS 'servicePointWriteOffId',

              fec.order_id, soc.order_no, so.workcard_id AS 'workCardId', so.parent_biz_order_id,
              so.data_source AS 'dataSource.value', sof.order_payment_type AS 'paymentType.value', sof.expect_charge, sof.blocked_charge,
              soc.product_category_id AS 'productCategory.id',

              soc.customer_id AS 'customer.id', so.shop_id AS 'shop.value',

              soc.user_name, soc.phone1 AS 'userPhone', CONCAT(soc.area_name,' ', soc.address) AS 'userAddress',
              soc.status AS 'status.value', so.description, soc.create_by AS 'createBy.id',soc.create_date,
              soc.kefu_id AS 'keFu.id', soc.close_date, sos.charge_date, sos.plan_date, soc.appointment_date,
              so.orderitem_json AS 'orderItemPb',

              fec.create_date AS 'writeOffCreateDate', fec.remarks AS 'writeOffRemarks',
              fec.service_charge, fec.material_charge, fec.travel_charge, fec.express_charge, fec.other_charge,

              fec.service_point_id AS 'servicePoint.id', fec.engineer_id AS 'engineer.id'
        FROM 	fi_engineercharge fec
              LEFT JOIN sd_order_condition soc ON soc.order_id = fec.order_id
              LEFT JOIN sd_order_head so ON so.id = soc.order_id
              LEFT JOIN sd_order_status sos ON sos.order_id = soc.order_id
              LEFT JOIN sd_order_fee sof ON sof.order_id = soc.order_id
        WHERE fec.quarter = #{quarter} AND fec.create_date >= #{beginDate} AND <![CDATA[ fec.create_date < #{endDate} ]]>
              AND fec.charge_order_type = 1
              AND fec.del_flag = 0
        LIMIT	200000
    </select>

    <select id="getOrderListByOrderIdsFromWebDB" resultType="com.kkl.kklplus.entity.rpt.RPTServicePointWriteOffEntity">
        SELECT
        soc.order_id, soc.order_no, so.workcard_id AS 'workCardId', so.parent_biz_order_id,
        so.data_source AS 'dataSource.value', sof.order_payment_type AS 'paymentType.value', sof.expect_charge,
        sof.blocked_charge,
        soc.product_category_id AS 'productCategory.id',

        soc.customer_id AS 'customer.id', so.shop_id AS 'shop.value',

        soc.user_name, soc.phone1 AS 'userPhone', CONCAT(soc.area_name,' ', soc.address) AS 'userAddress',
        soc.status AS 'status.value', so.description, soc.create_by AS 'createBy.id',soc.create_date,
        soc.kefu_id AS 'keFu.id', soc.close_date, sos.charge_date, sos.plan_date, soc.appointment_date,
        so.orderitem_json AS 'orderItemPb'
        FROM sd_order_condition soc
        INNER JOIN sd_order_head so ON so.id = soc.order_id
        INNER JOIN sd_order_status sos ON sos.order_id = soc.order_id
        INNER JOIN sd_order_fee sof ON sof.order_id = soc.order_id
        <where>
            <choose>
                <when test="orderIds != null and orderIds.size > 0">
                    soc.order_id IN
                    <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                        #{orderId}
                    </foreach>
                </when>
                <otherwise>
                    FALSE
                </otherwise>
            </choose>
        </where>
        LIMIT 100
    </select>

    <select id="getOrderDetailListFromWebDB" resultType="com.kkl.kklplus.entity.rpt.web.RPTOrderDetail">
        SELECT
              sod.id, sod.order_id, sod.servicepoint_id AS 'servicePoint.id', sod.engineer_id AS 'engineer.id',
              sod.service_times, sod.service_type_id AS 'serviceType.id',
              sod.product_id AS 'product.id', sod.product_spec, sod.brand, sod.qty, sod.remarks
        FROM  sd_orderdetail sod
              INNER JOIN fi_engineercharge fec ON fec.order_id = sod.order_id
        WHERE fec.quarter = #{quarter} AND fec.create_date >= #{beginDate} AND <![CDATA[ fec.create_date < #{endDate} ]]>
              AND sod.del_flag = 0
              AND fec.charge_order_type = 1
        LIMIT 200000
    </select>

    <select id="getOrderDetailListByOrderIdsFromWebDB" resultType="com.kkl.kklplus.entity.rpt.web.RPTOrderDetail">
        SELECT
        sod.id, sod.order_id, sod.servicepoint_id AS 'servicePoint.id', sod.engineer_id AS 'engineer.id',
        sod.service_times, sod.service_type_id AS 'serviceType.id',
        sod.product_id AS 'product.id', sod.product_spec, sod.brand, sod.qty, sod.remarks
        FROM sd_orderdetail sod
        <where>
            sod.del_flag = 0
            <choose>
                <when test="orderIds != null and orderIds.size > 0">
                    AND sod.order_id IN
                    <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                        #{orderId}
                    </foreach>
                </when>
                <otherwise>
                    FALSE
                </otherwise>
            </choose>
        </where>
        LIMIT 100
    </select>


    <insert id="insert" parameterType="com.kkl.kklplus.entity.rpt.RPTServicePointWriteOffEntity">
        INSERT INTO rpt_servicepoint_write_off
        (
            service_point_write_off_id,
            system_id,
            order_id,
            service_point_id,
            engineer_id,
            order_no,
            workcard_id,
            parent_biz_order_id,
            data_source,
            payment_type,
            expect_charge,
            blocked_charge,
            product_category_id,
            customer_id,
            customer_name,
            customer_code,
            contract_date,
            customer_payment_type_name,
            sales_name,
            shop_name,
            user_name,
            user_phone,
            user_address,
            status,
            status_label,
            warranty_status,
            description,
            create_by_name,
            create_date,
            close_date,
            charge_date,
            kefu_name,
            plan_date,
            appointment_date,
            write_off_create_date,
            write_off_remarks,
            service_charge,
            material_charge,
            express_charge,
            travel_charge,
            other_charge,
            order_item_pb,
            order_detail_pb,
            service_point_pb,
            engineer_pb,
            quarter
        )
        VALUES
        (
            #{servicePointWriteOffId},
            #{systemId},
            #{orderId},
            #{servicePoint.id},
            #{engineer.id},
            #{orderNo},
            #{workCardId},
            #{parentBizOrderId},
            #{dataSource.value},
            #{paymentType.value},
            #{expectCharge},
            #{blockedCharge},
            #{productCategory.id},
            #{customer.id},
            #{customer.name},
            #{customer.code},
            #{customer.contractDt},
            #{customer.paymentType.label},
            #{customer.sales.name},
            #{shop.label},
            #{userName},
            #{userPhone},
            #{userAddress},
            #{status.value},
            #{status.label},
            #{warrantyStatus},
            #{description},
            #{createBy.name},
            #{createDt},
            #{closeDt},
            #{chargeDt},
            #{keFu.name},
            #{planDt},
            #{appointmentDt},
            #{writeOffCreateDt},
            #{writeOffRemarks},
            #{serviceCharge},
            #{materialCharge},
            #{expressCharge},
            #{travelCharge},
            #{otherCharge},
            #{orderItemPb},
            #{orderDetailPb},
            #{servicePointPb},
            #{engineerPb},
            #{quarter}
        )
    </insert>

    <sql id="servicePointWriteOffColumns">
        a.id,
        a.service_point_write_off_id,
        a.system_id,
        a.order_id,
        a.service_point_id,
        a.engineer_id,
        a.order_no,
        a.workcard_id                 AS "workCardId",
        a.parent_biz_order_id,
        a.data_source                 AS "dataSource.value",
        a.payment_type                AS "paymentType.value",
        a.expect_charge,
        a.blocked_charge,
        a.product_category_id         AS "productCategory.id",
        a.customer_id                 AS "customer.id",
        a.customer_name               AS "customer.name",
        a.customer_code               AS "customer.code",
        a.contract_date               AS "customer.contractDt",
        a.customer_payment_type_name  AS "customer.paymentType.label",
        a.sales_name                  AS "customer.sales.name",
        a.shop_name                   AS "shop.label",
        a.user_name,
        a.user_phone,
        a.user_address,
        a.status                      AS "status.value",
        a.status_label                AS "status.label",
        a.description,
        a.create_by_name              AS "createBy.name",
        a.create_date                 AS "createDt",
        a.close_date                  AS "closeDt",
        a.charge_date                 AS "chargeDt",
        a.kefu_name                   AS "keFu.name",
        a.plan_date                   AS "planDt",
        a.appointment_date            AS "appointmentDt",
        a.write_off_create_date       AS "writeOffCreateDt",
        a.write_off_remarks,
        a.service_charge,
        a.material_charge,
        a.express_charge,
        a.travel_charge,
        a.other_charge,
        a.praise_fee                  AS "engineerPraiseFee",
        a.tax_fee                     AS "engineerTaxFee",
        a.info_fee                    AS "engineerInfoFee",
        a.engineer_deposit,
        a.order_item_pb,
        a.order_detail_pb,
        a.service_point_pb,
        a.engineer_pb,
        a.quarter
    </sql>

    <select id="getServicePointWriteOffIds" resultType="com.kkl.kklplus.provider.rpt.entity.LongTwoTuple">
        SELECT
              a.id                            AS "aElement",
              a.service_point_write_off_id    AS "bElement"
        FROM  rpt_servicepoint_write_off a
        WHERE a.quarter = #{quarter}
              AND a.system_id = #{systemId}
              AND a.write_off_create_date >= #{beginWriteOffCreateDate}
              AND <![CDATA[ a.write_off_create_date <= #{endWriteOffCreateDate} ]]>
        LIMIT 200000
    </select>

    <delete id="deleteServicePointWriteOffs">
        DELETE FROM rpt_servicepoint_write_off
        WHERE quarter = #{quarter}
              AND system_id = #{systemId}
              AND write_off_create_date >= #{beginWriteOffCreateDate}
              AND <![CDATA[ write_off_create_date <= #{endWriteOffCreateDate}






        ]]>
    </delete>


    <select id="getServicePointWriteOffListByPaging"
            resultType="com.kkl.kklplus.entity.rpt.RPTServicePointWriteOffEntity">
        SELECT
        <include refid="servicePointWriteOffColumns"/>
        FROM rpt_servicepoint_write_off a
        <where>
            <if test="quarter != null and quarter != ''.toString()">
                a.quarter = #{quarter}
            </if>
            AND a.system_id = #{systemId}
            <if test="servicePointId != null and servicePointId > 0">
                AND a.customer_id = #{customerId}
            </if>
            <if test="productCategoryId != null and productCategoryId > 0">
                AND a.product_category_id = #{productCategoryId}
            </if>
            <if test="paymentType != null and paymentType > 0">
                AND a.payment_type = #{paymentType}
            </if>
            <if test="beginWriteOffCreateDate != null and beginWriteOffCreateDate > 0">
                AND a.write_off_create_date >= #{beginWriteOffCreateDate}
            </if>
            <if test="endWriteOffCreateDate != null and endWriteOffCreateDate > 0">
                AND <![CDATA[ a.write_off_create_date <= #{endWriteOffCreateDate} ]]>
            </if>
        </where>
    </select>

    <select id="getNrPointWriteOffListByPage" resultType="com.kkl.kklplus.entity.rpt.RPTServicePointOderEntity">
        SELECT
        <include refid="servicePointWriteOffColumns"/>
        FROM rpt_servicepoint_write_off a
        <where>
            <if test="quarter != null and quarter != ''.toString()">
                a.quarter = #{quarter}
            </if>
            AND a.system_id = #{systemId}
            <if test="servicePointId != null and servicePointId > 0">
                AND a.service_point_id = #{servicePointId}
            </if>
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        AND a.product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        AND a.product_category_id IN
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </if>
            <if test="beginWriteOffCreateDate != null and beginWriteOffCreateDate > 0">
                AND a.write_off_create_date >= #{beginWriteOffCreateDate}
            </if>
            <if test="endWriteOffCreateDate != null and endWriteOffCreateDate > 0">
                AND <![CDATA[ a.write_off_create_date <= #{endWriteOffCreateDate} ]]>
            </if>
        </where>
        LIMIT #{limitOffset},#{limitRowCount}
    </select>

    <select id="getServicePointWriteSum" resultType="java.lang.Integer">
        SELECT
        COUNT(0)
        FROM rpt_servicepoint_write_off a
        <where>
            <if test="quarter != null and quarter != ''.toString()">
                a.quarter = #{quarter}
            </if>
            AND a.system_id = #{systemId}
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        AND a.product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        AND a.product_category_id IN
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </if>
            <if test="servicePointId != null and servicePointId > 0">
                AND a.service_point_id = #{servicePointId}
            </if>
            <if test="beginWriteOffCreateDate != null and beginWriteOffCreateDate > 0">
                AND a.write_off_create_date >= #{beginWriteOffCreateDate}
            </if>
            <if test="endWriteOffCreateDate != null and endWriteOffCreateDate > 0">
                AND <![CDATA[ a.write_off_create_date <= #{endWriteOffCreateDate} ]]>
            </if>
        </where>
    </select>
    <select id="getServicePointTotalPayablePaidBalanceByServicePoint"
            resultType="com.kkl.kklplus.entity.rpt.ServicePointChargeRptEntity">
        SELECT
        payable.servicepoint_id,
        sum(payable.m${selectedMonth}) as payableAmount, sum(paid.m${selectedMonth}) as paidAmount,
        sum(balance.m${selectedMonth}) as theBalance
        FROM fi_servicepoint_payable_monthly_detail payable
        left join fi_servicepoint_invoice_monthly_detail paid on paid.id = payable.id and paid.year = #{selectedYear}
        left join rpt_servicepoint_balance_monthly_detail balance on balance.id = payable.id and balance.year =
        #{selectedYear}
        <where>
            payable.year = #{selectedYear}
            <if test="servicePointId != null and servicePointId > 0">
                AND payable.servicepoint_id = #{servicePointId}
            </if>
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        AND payable.product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        AND payable.product_category_id IN
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="getServicePointTotalBalanceByServicePoint" resultType="com.kkl.kklplus.entity.rpt.ServicePointChargeRptEntity">
        SELECT
        balance.servicepoint_id, sum(balance.m${selectedMonth}) as preBalance
        FROM rpt_servicepoint_balance_monthly_detail balance
        <where>
            balance.year = #{selectedYear}
            <if test="servicePointId != null and servicePointId > 0">
                AND balance.servicepoint_id = #{servicePointId}
            </if>
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        AND balance.product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        AND balance.product_category_id IN
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="getNrPointWriteOff" resultType="com.kkl.kklplus.entity.rpt.ServicePointChargeRptEntity">
        SELECT
        payable_amount AS "payableAmount",
        last_month_balance AS "preBalance",
        paid_amount AS "paidAmount",
        the_balance AS "theBalance",
        tax_fee AS "engineerTaxFee",
        info_fee AS "engineerInfoFee",
        engineer_deposit AS "engineerDeposit"
        FROM rpt_servicepoint_charge
        <where>
            yearmonth = #{yearmonth}
            <if test="quarter != null and quarter != ''.toString()">
               AND quarter = #{quarter}
            </if>
            AND system_id = #{systemId}
            <if test="servicePointId != null and servicePointId > 0">
                AND service_point_id = #{servicePointId}
            </if>
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        AND product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        AND product_category_id IN
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>
</mapper>