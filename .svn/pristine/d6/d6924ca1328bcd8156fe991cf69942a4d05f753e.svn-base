<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kkl.kklplus.provider.rpt.mapper.CustomerComplainRptMapper">

    <select id="getCustomerComplainData" resultType="com.kkl.kklplus.entity.rpt.RPTCustomerComplainEntity">
        SELECT
            socp.order_id,
            socp.order_no,
            socp.complain_no,
            socp.customer_id,
            socp.kefu_name AS "keFuName",
            socp.user_address,
            socp.area_id,
            socp.servicepoint_id AS "servicePointId",
            socp.complain_type AS "complainType.value",
            socp.complain_object,
            socp.complain_item ,
            socp.complain_remark,
            socp.complain_date,
            socp.judge_item,
            socp.judge_object,
            socp.judge_remark,
            socp.complete_result,
            socp.complete_remark,
            socp.status AS "status.value",
            socp.complete_date,
            socp.complete_by,
            socp.complete_by_name,
            socp.customer_amount,
            socp.user_amount,
            socp.servicepoint_amount,
            socp.kefu_amount AS "keFuAmount",
            soc.engineer_id
        FROM sd_order_complain socp
        INNER JOIN sd_order_condition soc ON soc.order_id = socp.order_id
        <if test="salesId != null and salesId != 0 and (customerId == null || customerId == 0) ">
            inner join md_customer_sales mcs on mcs.customer_id = socp.customer_id
            <if test="subFlag == 3" >
                inner join sys_user_sub as sus on sus.sub_user_id = mcs.sales_id and sus.type = 7
            </if>
        </if>
        WHERE
            socp.complain_date between #{startDate} and #{endDate}
        <choose>
            <when test="customerId != null and customerId != 0">
                AND socp.customer_id = #{customerId}
            </when>
            <when test="salesId != null and salesId != 0">
                <choose>
                    <when test="subFlag == 3">
                        and sus.user_id = #{salesId}
                    </when>
                    <otherwise>
                        and mcs.sales_id = #{salesId}
                    </otherwise>
                </choose>
            </when>
            <otherwise>
            </otherwise>
        </choose>
        <if test="keFuId!=null">
            and socp.kefu_id = #{keFuId}
        </if>
        <if test="areaId!=null">
            and socp.area_id = #{areaId}
        </if>
        <if test="servicePointId!=null">
            and socp.servicePoint_id = #{servicePointId}
        </if>
        <if test="complainStatus!=null">
            and socp.status = #{complainStatus}
        </if>
        <if test="productCategoryIds.size() != 0">
            <choose>
                <when test="productCategoryIds.size() == 1">
                    and socp.product_category_id = #{productCategoryIds[0]}
                </when>
                <otherwise>
                    and socp.product_category_id in
                    <foreach item="item" index="index" collection="productCategoryIds" open="("
                             separator="," close=")">
                        #{item}
                    </foreach>
                </otherwise>
            </choose>
        </if>
        ORDER BY socp.order_id
    </select>


    <select id="hasReportData" resultType="java.lang.Integer">
        SELECT
            count(0)
        FROM sd_order_complain socp
        INNER JOIN sd_order_condition soc ON soc.order_id = socp.order_id
        <if test="salesId != null and salesId != 0 and (customerId == null || customerId == 0) ">
            inner join md_customer_sales mcs on mcs.customer_id = socp.customer_id
            <if test="subFlag == 3" >
                inner join sys_user_sub as sus on sus.sub_user_id = mcs.sales_id and sus.type = 7
            </if>
        </if>
        WHERE
            socp.complain_date between #{startDate} and #{endDate}
            <choose>
                <when test="customerId != null and customerId != 0">
                    AND socp.customer_id = #{customerId}
                </when>
                <when test="salesId != null and salesId != 0">
                    <choose>
                        <when test="subFlag == 3">
                            and sus.user_id = #{salesId}
                        </when>
                        <otherwise>
                            and mcs.sales_id = #{salesId}
                        </otherwise>
                    </choose>
                </when>
                <otherwise>
                </otherwise>
            </choose>
            <if test="keFuId!=null">
                and socp.kefu_id = #{keFuId}
            </if>
            <if test="areaId!=null">
                and socp.area_id = #{areaId}
            </if>
            <if test="servicePointId!=null">
                and socp.servicePoint_id = #{servicePointId}
            </if>
            <if test="complainStatus!=null">
                and socp.status = #{complainStatus}
            </if>
            <if test="productCategoryIds.size() != 0">
                <choose>
                    <when test="productCategoryIds.size() == 1">
                        and socp.product_category_id = #{productCategoryIds[0]}
                    </when>
                    <otherwise>
                        and socp.product_category_id in
                        <foreach item="item" index="index" collection="productCategoryIds" open="("
                                 separator="," close=")">
                            #{item}
                        </foreach>
                        and
                    </otherwise>
                </choose>
            </if>
    </select>
</mapper>